suite: test configmap
templates:
  - templates/configmap.yaml
tests:
  - it: config with defaults
    set:
      licenseKey: license-key-test
      cluster: cluster-test
    asserts:
      - equal:
          path: data.config\.yaml
          value: |-
            # Configuration for newrelic-prometheus-configurator
            data_source_name: cluster-test
            newrelic_remote_write:
            common:
              external_labels:
                cluster_name: cluster-test

  - it: staging is enabled
    set:
      licenseKey: license-key-test
      cluster: cluster-test
      nrStaging: true
    asserts:
      - matchRegex:
          path: data.config\.yaml
          pattern: ".*staging: true.*"
  - it: config including most possible sections
    set:
      licenseKey: license-key-test
      cluster: cluster-test
      nrStaging: true
      config:
        remote_write:
          proxy_url: http://proxy.url
          remote_timeout: 30s
          tls_config:
            insecure_skip_verify: true
          queue_config:
            retry_on_http_429: false
          extra_write_relabel_configs:
            - source_labels:
              - __name__
              - instance
              regexp: node_memory_active_bytes;localhost:9100
              action: drop
        extra_remote_write:
          - url: "https://second.remote.write"
    asserts:
      - equal:
          path: data.config\.yaml
          value: |-
            # Configuration for newrelic-prometheus-configurator
            data_source_name: cluster-test
            newrelic_remote_write:
              staging: true
                extra_write_relabel_configs:
                - action: drop
                  regexp: node_memory_active_bytes;localhost:9100
                  source_labels:
                  - __name__
                  - instance
                proxy_url: http://proxy.url
                queue_config:
                  retry_on_http_429: false
                remote_timeout: 30s
                tls_config:
                  insecure_skip_verify: true
            extra_remote_write:
                - url: https://second.remote.write
            common:
              external_labels:
                cluster_name: cluster-test

  - it: cluster_name is set from global
    set:
      global:
       cluster: "test"
    asserts:
      - equal:
          path: data.config\.yaml
          value: |-
            # Configuration for newrelic-prometheus-configurator
            data_source_name: test
            newrelic_remote_write:
            common:
              external_labels:
                cluster_name: test
  - it: cluster_name local value has precedence over global precedence
    set:
      global:
        cluster: "test"
      cluster: "test2"
    asserts:
      - equal:
          path: data.config\.yaml
          value: |-
            # Configuration for newrelic-prometheus-configurator
            data_source_name: test2
            newrelic_remote_write:
            common:
              external_labels:
                cluster_name: test2
  - it: cluster_name is not overwritten from customAttributes
    set:
      global:
        cluster: "test"
      cluster: "test2"
      customAttributes:
        cluster_name: "test3"
    asserts:
      - equal:
          path: data.config\.yaml
          value: |-
            # Configuration for newrelic-prometheus-configurator
            data_source_name: test2
            newrelic_remote_write:
            common:
              external_labels:
                cluster_name: test2

  - it: cluster_name has precedence over extra labels has precedence over customAttributes
    set:
      cluster: test
      customAttributes:
        attribute: "value"
        one: error
        cluster_name: "different"
      config:
        common:
          external_labels:
            one: two
            cluster_name: "different"
          scrape_interval: 15
    asserts:
      - equal:
          path: data.config\.yaml
          value: |-
            # Configuration for newrelic-prometheus-configurator
            data_source_name: test
            newrelic_remote_write:
            common:
              external_labels:
                attribute: value
                cluster_name: test
                one: two
              scrape_interval: 15
