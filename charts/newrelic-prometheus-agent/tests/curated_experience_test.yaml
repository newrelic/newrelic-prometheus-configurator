suite: test configmap with CuratedExperience
templates:
  - templates/configmap.yaml
tests:
  - it: config with CuratedExperience true
    set:
      licenseKey: license-key-test
      cluster: cluster-test
      config:
        kubernetes:
          curated_experience:
            enabled: true
        # Set empty to make this test simple
        static_targets:
    asserts:
      - equal:
          path: data.config\.yaml
          value: |-
            # Configuration for newrelic-prometheus-configurator
            common:
              external_labels:
                cluster_name: cluster-test
              scrape_interval: 30s
            kubernetes:
              jobs:
              - job_name_prefix: kubernetes-job
                target_discovery:
                  endpoints: true
                  filter:
                    annotations:
                      prometheus.io/scrape: true
                  pod: true
              - job_name_prefix: newrelic-job
                target_discovery:
                  endpoints: true
                  filter:
                    annotations:
                      newrelic.io/scrape: true
                  pod: true
              curated_experience:
                enabled: true
                app_values:
                  - redis
                  - mongodb
                  - consul
                  - calico
                  - ingress-nginx
                source_labels:
                  - app.kubernetes.io/name
                  - app.newrelic.io/name
                jobs_prefix:
                  - kubernetes-job

  - it: config with CuratedExperience false
    set:
      licenseKey: license-key-test
      cluster: cluster-test
      config:
        kubernetes:
          curated_experience:
            enabled: false
        # Set empty to make this test simple
        static_targets:
    asserts:
      - equal:
          path: data.config\.yaml
          value: |-
            # Configuration for newrelic-prometheus-configurator
            common:
              external_labels:
                cluster_name: cluster-test
              scrape_interval: 30s
            kubernetes:
              jobs:
              - job_name_prefix: kubernetes-job
                target_discovery:
                  endpoints: true
                  filter:
                    annotations:
                      prometheus.io/scrape: true
                  pod: true
              - job_name_prefix: newrelic-job
                target_discovery:
                  endpoints: true
                  filter:
                    annotations:
                      newrelic.io/scrape: true
                  pod: true
