name: E2E over minikube (External Contribution)

on:
  pull_request_target:

permissions:
  contents: read

env:
  # NOTICE that apart from this, the versions in the chart linter matrix needs to be bumped too.
  LATEST_K8S_VERSION: 'v1.34.0'
  MINIKUBE_VERSION: 'v1.37.0'

jobs:
  e2e-test-external:
    name: Run E2E Tests (External Contribution)
    # Do not run e2e tests if PR has skip-e2e label or if it's a non-forked repo (internal contribution)
    if: ${{ !contains(github.event.pull_request.labels.*.name, 'ci/skip-e2e') && github.event.pull_request.head.repo.full_name != 'newrelic/newrelic-prometheus-configurator' }}
    runs-on: ubuntu-latest
    environment: E2E # Required so that approval is required to run this job since it is untrusted (forked).
    # If the environment is broken this job could timeout since the default timeout for tilt ci is 30m.
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Setup Minikube
        uses: manusa/actions-setup-minikube@v2.14.0
        with:
          minikube version: ${{ env.MINIKUBE_VERSION }}
          kubernetes version: ${{ env.LATEST_K8S_VERSION }}
          # default driver doesn't support 'eval $$(minikube docker-env)'.
          driver: docker
          github token: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
      # tilt 0.33.3 introduces a breaking change that results in
      # "ERROR: Failed to connect to Docker: Error response from daemon: Client sent an HTTP request to an HTTPS server."
      # So we explicitly adopt tilt 0.33.2 to prevent the E2e Tests failure.
      - name: Install Tilt
        run: |
          curl -fsSL https://github.com/tilt-dev/tilt/releases/download/v0.33.2/tilt.0.33.2.linux.x86_64.tar.gz | tar -xzv tilt && sudo mv tilt /usr/local/bin/tilt
      - name: Run e2e-test
        uses: newrelic/newrelic-integration-e2e-action@v1
        with:
          retry_seconds: 90
          retry_attempts: 5
          agent_enabled: false
          spec_path: test/e2e/test-specs.yml
          account_id: ${{ secrets.K8S_AGENTS_E2E_ACCOUNT_ID }}
          api_key: ${{ secrets.K8S_AGENTS_E2E_API_KEY }}
          license_key: ${{ secrets.K8S_AGENTS_E2E_LICENSE_KEY }}
